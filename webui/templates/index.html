<!DOCTYPE html>
<html>
<head>
    <title>MyC2 Framework - Web Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .agent { border-left: 4px solid #4CAF50; padding: 10px; margin: 5px 0; }
        .agent.offline { border-left-color: #f44336; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        .btn { background: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #45a049; }
    </style>
</head>
<body>
    <div class="container">
        <h1>MyC2 Framework Dashboard</h1>
        
        <div class="grid">
            <div class="card">
                <h2>Active Agents</h2>
                <div id="agents-list"></div>
            </div>
            
            <div class="card">
                <h2>Quick Actions</h2>
                <button class="btn" onclick="showJobModal()">Create Job</button>
                <button class="btn" onclick="refreshData()">Refresh</button>
            </div>
        </div>
        
        <div class="card">
            <h2>Recent Jobs</h2>
            <table id="jobs-table">
                <thead>
                    <tr>
                        <th>Job ID</th>
                        <th>Agent</th>
                        <th>Module</th>
                        <th>Status</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Job Modal -->
    <div id="jobModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
        <div style="background: white; margin: 50px auto; padding: 20px; width: 500px; border-radius: 5px;">
            <h3>Create New Job</h3>
            <form id="jobForm">
                <div style="margin: 10px 0;">
                    <label>Agent:</label>
                    <select id="agentSelect" style="width: 100%; padding: 5px;"></select>
                </div>
                <div style="margin: 10px 0;">
                    <label>Module:</label>
                    <select id="moduleSelect" style="width: 100%; padding: 5px;"></select>
                </div>
                <div style="margin: 10px 0;">
                    <label>Arguments (JSON):</label>
                    <textarea id="jobArgs" style="width: 100%; height: 100px; padding: 5px;"></textarea>
                </div>
                <div>
                    <button type="submit" class="btn">Execute</button>
                    <button type="button" class="btn" onclick="hideJobModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Refresh data every 10 seconds
        setInterval(loadData, 10000);
        
        function loadData() {
            fetch('/api/agents')
                .then(r => r.json())
                .then(agents => {
                    const agentsList = document.getElementById('agents-list');
                    agentsList.innerHTML = agents.map(agent => `
                        <div class="agent ${agent.status === 'active' ? '' : 'offline'}">
                            <strong>${agent.hostname}</strong> (${agent.username})<br>
                            <small>ID: ${agent.id} | IP: ${agent.internal_ip} | Last: ${agent.last_seen}</small>
                        </div>
                    `).join('');
                    
                    // Populate agent select
                    const agentSelect = document.getElementById('agentSelect');
                    agentSelect.innerHTML = agents.map(agent => 
                        `<option value="${agent.id}">${agent.hostname} (${agent.id})</option>`
                    ).join('');
                });
            
            fetch('/api/jobs')
                .then(r => r.json())
                .then(jobs => {
                    const tbody = document.querySelector('#jobs-table tbody');
                    tbody.innerHTML = jobs.map(job => `
                        <tr>
                            <td>${job.id}</td>
                            <td>${job.hostname || job.agent_id}</td>
                            <td>${job.module_name}</td>
                            <td>${job.status}</td>
                            <td>${job.created_at}</td>
                        </tr>
                    `).join('');
                });
        }
        
        function refreshData() {
            loadData();
        }
        
        function showJobModal() {
            document.getElementById('jobModal').style.display = 'block';
            
            // Load modules
            fetch('/api/modules')
                .then(r => r.json())
                .then(modules => {
                    const moduleSelect = document.getElementById('moduleSelect');
                    moduleSelect.innerHTML = modules.map(mod => 
                        `<option value="${mod.name}">${mod.name} - ${mod.description}</option>`
                    ).join('');
                });
        }
        
        function hideJobModal() {
            document.getElementById('jobModal').style.display = 'none';
        }
        
        document.getElementById('jobForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const agentId = document.getElementById('agentSelect').value;
            const moduleName = document.getElementById('moduleSelect').value;
            const argsText = document.getElementById('jobArgs').value;
            
            let arguments = {};
            try {
                arguments = argsText ? JSON.parse(argsText) : {};
            } catch (e) {
                alert('Invalid JSON in arguments');
                return;
            }
            
            fetch('/api/jobs', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({agent_id: agentId, module_name: moduleName, arguments: arguments})
            })
            .then(r => r.json())
            .then(result => {
                if (result.status === 'success') {
                    alert('Job created successfully');
                    hideJobModal();
                    refreshData();
                }
            });
        });
        
        // Initial load
        loadData();
    </script>
</body>
</html>